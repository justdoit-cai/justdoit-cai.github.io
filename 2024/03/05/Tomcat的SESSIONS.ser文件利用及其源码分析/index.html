<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Tomcat的SESSIONS.ser文件利用及其源码分析 | AnchorEureka' Blog</title><meta name="author" content="AnchorEureka"><meta name="copyright" content="AnchorEureka"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="介绍Tomcat 默认会开启 session 的持久化功能，它是通过当 Tomcat 正常退出的时候，会将 session 的值进行序列化，存到 work 目录下的 SESSIONS.ser 文件中（正常来说完整路径是 &lt;Tomcat的安装目录&gt;&#x2F;work&#x2F;Catalina&#x2F;localhost&#x2F;&lt;项目名&gt;&#x2F;SESSSIONS.ser），然后下次启动时会对这个文件中的内容进行">
<meta property="og:type" content="article">
<meta property="og:title" content="Tomcat的SESSIONS.ser文件利用及其源码分析">
<meta property="og:url" content="https://justdoittt.top/2024/03/05/Tomcat%E7%9A%84SESSIONS.ser%E6%96%87%E4%BB%B6%E5%88%A9%E7%94%A8%E5%8F%8A%E5%85%B6%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="AnchorEureka&#39; Blog">
<meta property="og:description" content="介绍Tomcat 默认会开启 session 的持久化功能，它是通过当 Tomcat 正常退出的时候，会将 session 的值进行序列化，存到 work 目录下的 SESSIONS.ser 文件中（正常来说完整路径是 &lt;Tomcat的安装目录&gt;&#x2F;work&#x2F;Catalina&#x2F;localhost&#x2F;&lt;项目名&gt;&#x2F;SESSSIONS.ser），然后下次启动时会对这个文件中的内容进行">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://justdoittt.top/img/haoyun.jpg">
<meta property="article:published_time" content="2024-03-04T16:00:00.000Z">
<meta property="article:modified_time" content="2024-03-04T19:10:45.834Z">
<meta property="article:author" content="AnchorEureka">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="Tomcat">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://justdoittt.top/img/haoyun.jpg"><link rel="shortcut icon" href="/img/bg4.jpg"><link rel="canonical" href="https://justdoittt.top/2024/03/05/Tomcat%E7%9A%84SESSIONS.ser%E6%96%87%E4%BB%B6%E5%88%A9%E7%94%A8%E5%8F%8A%E5%85%B6%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Tomcat的SESSIONS.ser文件利用及其源码分析',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-03-05 03:10:45'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/imgs/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">11</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">12</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">12</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/haoyun.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="AnchorEureka' Blog"><span class="site-name">AnchorEureka' Blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Tomcat的SESSIONS.ser文件利用及其源码分析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-03-04T16:00:00.000Z" title="发表于 2024-03-05 00:00:00">2024-03-05</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-03-04T19:10:45.834Z" title="更新于 2024-03-05 03:10:45">2024-03-05</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Java/">Java</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Java/Tomcat/">Tomcat</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">2.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>9分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Tomcat的SESSIONS.ser文件利用及其源码分析"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p><code>Tomcat</code> 默认会开启 <code>session</code> 的持久化功能，它是通过当 <code>Tomcat</code> 正常退出的时候，会将 <code>session</code> 的值进行序列化，存到 <code>work</code> 目录下的 <code>SESSIONS.ser</code> 文件中（正常来说完整路径是 <code>&lt;Tomcat的安装目录&gt;/work/Catalina/localhost/&lt;项目名&gt;/SESSSIONS.ser</code>），然后下次启动时会对这个文件中的内容进行反序列化（启动成功后就会删除 <code>SESSIONS.ser</code> 文件），从而恢复 <code>session</code> 的值。</p>
<p><img src="/imgs/Pasted%20image%2020240304011830.png"></p>
<p>如果我们可以控制 <code>SESSIONS.ser</code> 文件的内容（往往是通过任意文件上传），就可能造成反序列化漏洞。</p>
<h1 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h1><p>这里先来分析一下 <code>SESSIONS.ser</code> 文件的内容。先来试着写入值到 <code>session</code> 中，然后关闭 <code>Tomcat</code> 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.just.servlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.just.pojo.User;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpSession;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebServlet(&quot;/demo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DemoServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="type">HttpSession</span> <span class="variable">session</span> <span class="operator">=</span> req.getSession();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">user</span> <span class="operator">=</span> session.getAttribute(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;user = &quot;</span> + user);</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">            session.setAttribute(<span class="string">&quot;user&quot;</span>, <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;test&quot;</span>, <span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后可以得到上面的 <code>session</code> 对应的 <code>SESSIONS.ser</code> 文件。</p>
<p><img src="/imgs/Pasted%20image%2020240304011938.png"></p>
<p>根据开头的序列化魔数 <code>ACED0005</code> ，就可以很明显的知道里面存的是 <code>jdk</code> 原生序列化的内容。至于其内容存的信息，我们可以分析其源码。</p>
<p>我们可以找到持久化 <code>session</code> 的源码在 <code>org.apache.catalina.session.StandardSession</code> 类中的 <code>doReadObject()</code> 和 <code>doWriteObject()</code> 方法中。</p>
<p><img src="/imgs/Pasted%20image%2020240304023201.png"></p>
<p>根据这里的源码，我们就可以知道其序列化存的信息是什么了。但是这里需要注意的是，如果熟悉序列化的结构的人，会发现这里貌似源码和 <code>SESSIONS.ser</code> 文件的内容对不上。因为 <code>SESSIONS.ser</code> 文件中的第一块序列化的数据很明显是 <code>java.lang.Integer</code> 类型的，而源码中第一次 <code>readObject()</code> 返回的结果显示是 <code>Long</code> 类型的。很明显在 <code>doReadObject()</code> 之前还有一次反序列化。然后不难找到，在这里传入 <code>stream</code> 给 <code>doReadObject()</code> 方法的时候其实已经操作过 <code>stream</code> 了。</p>
<p><img src="/imgs/Pasted%20image%2020240304024013.png"></p>
<p>这下就对的上了。</p>
<p>根据分析源码，不难得到这里 <code>SESSIONS.ser</code> 的结构是：</p>
<blockquote>
<p>开头一个数字标识有几个 <code>session</code> ，然后后面的就是各个 <code>session</code> 的具体信息。</p>
</blockquote>
<p>有一点需要注意的是的是：</p>
<blockquote>
<p>我们可以发现这里都是调用的 <code>readObject()</code> 然后对结果进行强制类型转化，而非调用 <code>readInt()</code> ，<code>readDouble()</code> 方法。这样我们构造恶意的 <code>SESSIONS.ser</code> 文件就很容易了，就不需要在意其结构，就直接写入一个恶意的对象。因为对 <code>readObject()</code> 结果进行强制类型转化并不会影响反序列化漏洞，而调用的不是 <code>readObject()</code> 而是其它 <code>readXxx()</code> 方法，就需要考虑写入 <code>SESSIONS.ser</code> 文件的结构才能实现反序列化漏洞。<br>不过再怎么样也都可以造成反序列化漏洞，这里只是说明一下为什么直接序列化一个恶意的对象到 <code>SESSIONS.ser</code> 文件中就可以造成反序列化漏洞了。</p>
</blockquote>
<p>然后我们分析一下 是怎么调用的 <code>doReadObject()</code> 和 <code>doWriteObject()</code> 方法。</p>
<p>我们可以调试 <code>Tomcat</code> 启动的过程。发现其核心关于持久化 <code>session</code> 的逻辑在 <code>org.apache.catalina.session.StandardManager</code> 中。其通过 <code>doLoad()</code> 方法在 <code>Tomcat</code> 停止的时候加载 <code>SESSIONS.ser</code> 文件然后删除 <code>SESSIONS.ser</code> 文件，通过 <code>doUnload()</code> 方法在 <code>Tomcat</code> 停止的时候存储 <code>session</code> 的内容到 <code>SESSION.ser</code> 文件中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doLoad</span><span class="params">()</span> <span class="keyword">throws</span> ClassNotFoundException, IOException &#123;</span><br><span class="line">	<span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">		log.debug(<span class="string">&quot;Start: Loading persisted sessions&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Initialize our internal data structures</span></span><br><span class="line">	sessions.clear();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Open an input stream to the specified pathname, if any</span></span><br><span class="line">	<span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> file();</span><br><span class="line">	<span class="keyword">if</span> (file == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">		log.debug(sm.getString(<span class="string">&quot;standardManager.loading&quot;</span>, pathname));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">Loader</span> <span class="variable">loader</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">	<span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">	<span class="type">Log</span> <span class="variable">logger</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">	<span class="keyword">try</span> (<span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file.getAbsolutePath());</span><br><span class="line">			<span class="type">BufferedInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(fis)) &#123;</span><br><span class="line">		<span class="type">Context</span> <span class="variable">c</span> <span class="operator">=</span> getContext();</span><br><span class="line">		loader = c.getLoader();</span><br><span class="line">		logger = c.getLogger();</span><br><span class="line">		<span class="keyword">if</span> (loader != <span class="literal">null</span>) &#123;</span><br><span class="line">			classLoader = loader.getClassLoader();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (classLoader == <span class="literal">null</span>) &#123;</span><br><span class="line">			classLoader = getClass().getClassLoader();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Load the previously unloaded active sessions</span></span><br><span class="line">		<span class="keyword">synchronized</span> (sessions) &#123;</span><br><span class="line">			<span class="keyword">try</span> (<span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CustomObjectInputStream</span>(bis, classLoader, logger,</span><br><span class="line">					getSessionAttributeValueClassNamePattern(),</span><br><span class="line">					getWarnOnSessionAttributeFilterFailure())) &#123;</span><br><span class="line">				<span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> (Integer) ois.readObject();</span><br><span class="line">				<span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> count.intValue();</span><br><span class="line">				<span class="keyword">if</span> (log.isDebugEnabled())</span><br><span class="line">					log.debug(<span class="string">&quot;Loading &quot;</span> + n + <span class="string">&quot; persisted sessions&quot;</span>);</span><br><span class="line">				<span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">					<span class="type">StandardSession</span> <span class="variable">session</span> <span class="operator">=</span> getNewSession();</span><br><span class="line">					session.readObjectData(ois);</span><br><span class="line">					session.setManager(<span class="built_in">this</span>);</span><br><span class="line">					sessions.put(session.getIdInternal(), session);</span><br><span class="line">					session.activate();</span><br><span class="line">					<span class="keyword">if</span> (!session.isValidInternal()) &#123;</span><br><span class="line">						<span class="comment">// If session is already invalid,</span></span><br><span class="line">						<span class="comment">// expire session to prevent memory leak.</span></span><br><span class="line">						session.setValid(<span class="literal">true</span>);</span><br><span class="line">						session.expire();</span><br><span class="line">					&#125;</span><br><span class="line">					sessionCounter++;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">				<span class="comment">// Delete the persistent storage file</span></span><br><span class="line">				<span class="keyword">if</span> (file.exists()) &#123;</span><br><span class="line">					file.delete();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">		<span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">			log.debug(<span class="string">&quot;No persisted data file found&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">		log.debug(<span class="string">&quot;Finish: Loading persisted sessions&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doUnload</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (log.isDebugEnabled())</span><br><span class="line">		log.debug(sm.getString(<span class="string">&quot;standardManager.unloading.debug&quot;</span>));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (sessions.isEmpty()) &#123;</span><br><span class="line">		log.debug(sm.getString(<span class="string">&quot;standardManager.unloading.nosessions&quot;</span>));</span><br><span class="line">		<span class="keyword">return</span>; <span class="comment">// nothing to do</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Open an output stream to the specified pathname, if any</span></span><br><span class="line">	<span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> file();</span><br><span class="line">	<span class="keyword">if</span> (file == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">		log.debug(sm.getString(<span class="string">&quot;standardManager.unloading&quot;</span>, pathname));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Keep a note of sessions that are expired</span></span><br><span class="line">	ArrayList&lt;StandardSession&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">try</span> (<span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(file.getAbsolutePath());</span><br><span class="line">			<span class="type">BufferedOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedOutputStream</span>(fos);</span><br><span class="line">			<span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(bos)) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">synchronized</span> (sessions) &#123;</span><br><span class="line">			<span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">				log.debug(<span class="string">&quot;Unloading &quot;</span> + sessions.size() + <span class="string">&quot; sessions&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// Write the number of active sessions, followed by the details</span></span><br><span class="line">			oos.writeObject(Integer.valueOf(sessions.size()));</span><br><span class="line">			<span class="keyword">for</span> (Session s : sessions.values()) &#123;</span><br><span class="line">				<span class="type">StandardSession</span> <span class="variable">session</span> <span class="operator">=</span> (StandardSession) s;</span><br><span class="line">				list.add(session);</span><br><span class="line">				session.passivate();</span><br><span class="line">				session.writeObjectData(oos);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Expire all the sessions we just wrote</span></span><br><span class="line">	<span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">		log.debug(<span class="string">&quot;Expiring &quot;</span> + list.size() + <span class="string">&quot; persisted sessions&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (StandardSession session : list) &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			session.expire(<span class="literal">false</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">			ExceptionUtils.handleThrowable(t);</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			session.recycle();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">		log.debug(<span class="string">&quot;Unloading complete&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>并且可以发现其存储的路径是通过下面的代码获取的：</p>
<p><img src="/imgs/Pasted%20image%2020240304031039.png"></p>
<p>这里的 <code>pathname</code> 默认值就是 <code>SESSIONS.ser</code> 。</p>
<p><img src="/imgs/Pasted%20image%2020240304031119.png"></p>
<h1 id="实验测试"><a href="#实验测试" class="headerlink" title="实验测试"></a>实验测试</h1><p>我们写一个 <code>cc9</code>  的反序列化 <code>exp</code> 到 <code>SESSIONS.ser</code> 文件中，然后启动 <code>Tomcat</code> ，发现成功命令执行。</p>
<p><img src="/imgs/Pasted%20image%2020240304032813.png"></p>
<h1 id="进一步分析"><a href="#进一步分析" class="headerlink" title="进一步分析"></a>进一步分析</h1><p>根据上面的分析，我们可以发现这种攻击方式其实很鸡肋，因为不仅需要程序项目没有用到 <code>session</code> （因为如果项目自身用到了 <code>session</code> ，那么在关闭 <code>Tomcat</code> 的时候写入 <code>session</code> 的内容到 <code>SESSIONS.ser</code> 文件中，就会覆盖我们上传的 <code>SESSIONS.ser</code> 文件，但是这点并不是很鸡肋，因为现在大部分的项目都是前后端分离，使用的是 <code>token</code> 鉴权而非 <code>session</code> ，所以现在很多项目都没有用 <code>session</code> ），最重要是需要重新启动 <code>Tomcat</code> 才能生效，而实战中我们几乎不可能让目标重启 <code>Tomcat</code> 。</p>
<p>有没有办法让目标不重启就可以加载 <code>SESSIONS.ser</code> 文件呢？</p>
<p>答案是可以的！</p>
<blockquote>
<p>Whenever Apache Tomcat is shut down normally and restarted, or when an application reload is triggered, the standard Manager implementation will attempt to serialize all currently active sessions to a disk file located via the pathname attribute. All such saved sessions will then be deserialized and activated (assuming they have not expired in the mean time) when the application reload is completed.</p>
</blockquote>
<p>因此根据官方文档可以看出来，除了服务停止或者重启，还可以让部署的程序触发 <code>reload</code> 来做到。</p>
<p><img src="/imgs/Pasted%20image%2020240304035048.png"></p>
<blockquote>
<p>这里的思路是参考 <code>2022 rwctf Desperate Cat</code> 的出题人 <code>wp</code> 的，其中 <code>wp</code> 利用到了这个技巧。</p>
</blockquote>
<p>让 <code>Tomcat</code> 部署的程序进行 <code>reload</code> 有两种方式：</p>
<h2 id="第一种reload的方式"><a href="#第一种reload的方式" class="headerlink" title="第一种reload的方式"></a>第一种reload的方式</h2><p>第一种 <code>reload</code> 的方式需要满足两个条件：</p>
<p><img src="/imgs/Pasted%20image%2020240304035422.png"></p>
<ol>
<li><code>Context reloadable</code> 配置为 <code>true</code>（默认是 <code>false</code> ）；</li>
<li><code>/WEB-INF/classes/</code> 或者 <code>/WEB-INF/lib/</code> 目录下的文件发生变化。</li>
</ol>
<p>由于 <code>Context reloadable</code> 默认是 <code>false</code> ，要动态修改它可以通过执行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;pageContext.servletContext.classLoader.resources.context.reloadable=true&#125;</span><br></pre></td></tr></table></figure>

<p>至于怎么修改，就具体情况具体分析了。</p>
<p>然后上传文件到 <code>/WEB-INF/classes/</code> 目录或者 <code>/WEB-INF/lib/</code> 目录下就可以触发 <code>Tomcat</code> <code>reload</code> 程序了。</p>
<blockquote>
<p>但是这里需要注意的是：如果上传的 <code>jar</code> 包或者 <code>class</code> 文件的格式错误，会导致程序异常崩溃，从而整个网页都无法正常访问了。</p>
</blockquote>
<p><img src="/imgs/Pasted%20image%2020240304040355.png"></p>
<h2 id="第二种reload的方式"><a href="#第二种reload的方式" class="headerlink" title="第二种reload的方式"></a>第二种reload的方式</h2><p>第一种方式由于需要修改 <code>reloadable</code> 的值，但是大部分情况应该都是改不了的，所以相对来说不是很好用。这里可以用第二种方式。</p>
<blockquote>
<p>WatchedResource - The auto deployer will monitor the specified static resource of the web application for updates, and will reload the web application if it is updated. The content of this element must be a string.</p>
</blockquote>
<p>在 <code>Tomcat 9</code> 环境下，默认的 <code>WatchedResource</code> 包括：</p>
<ul>
<li><code>WEB-INF/web.xml</code></li>
<li><code>WEB-INF/tomcat-web.xml</code></li>
<li><code>$&#123;CATALINA_HOME&#125;/conf/web.xml</code></li>
</ul>
<p><code>Tomcat</code> 会有后台线程去监控这些文件资源，在 <code>Tomcat</code> 开启 <code>autoDeploy</code> 的情况下（此值默认为 <code>true</code>，即默认开启 <code>autoDeploy</code> ），一旦发现这些文件资源的 <code>lastModified</code> 时间被修改，也会触发 <code>reload</code> ：</p>
<p><img src="/imgs/Pasted%20image%2020240305023934.png"></p>
<p>由于应用本身没有 <code>WEB-INF/tomcat-web.xml</code> 配置文件， 因此通过利用程序本身的写文件漏洞，来创建一个 <code>WEB-INF/tomcat-web.xml/</code> 目录，也可以让应用强行触发 <code>reload</code> ，加载并反序列化先前写入的恶意 <code>SESSIONS.ser</code> 文件。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>当 <code>Tomcat</code> 部署的程序具有任意文件上传漏洞的时候，我们可以先上传一个恶意的 <code>SESSIONS.ser</code> 文件到 <code>Tomcat</code> 的 <code>work</code> 目录，然后再上传一个 <code>WEB-INF/tomcat-web.xml</code> 文件（内容随便）来触发 <code>Tomcat</code> 的 <code>reload</code> ，进而反序列化 <code>SESSIONS.ser</code> 文件产生反序列化漏洞。</p>
<p>此外，如果靶机可以加载我们指定任意的类，我们还可以上传恶意的 <code>jar</code> 包到 <code>WEB-INF/lib/</code> 目录下，然后再来指定靶机加载我们恶意的 <code>jar</code> 包中的 <code>class</code> 文件，执行其中 <code>static</code> 代码块中的代码，造成 <code>RCE</code> 。这种方式好在不需要靶机有反序列化漏洞的组件，但是需要我们能够加载我们通过文件上传漏洞上传的 <code>jar</code> 包中的 <code>class</code> 文件。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://github.com/justdoit-cai">AnchorEureka</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://justdoittt.top/2024/03/05/Tomcat%E7%9A%84SESSIONS.ser%E6%96%87%E4%BB%B6%E5%88%A9%E7%94%A8%E5%8F%8A%E5%85%B6%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">https://justdoittt.top/2024/03/05/Tomcat%E7%9A%84SESSIONS.ser%E6%96%87%E4%BB%B6%E5%88%A9%E7%94%A8%E5%8F%8A%E5%85%B6%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://justdoittt.top" target="_blank">AnchorEureka' Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Java/">Java</a><a class="post-meta__tags" href="/tags/Tomcat/">Tomcat</a></div><div class="post_share"><div class="social-share" data-image="/img/haoyun.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/03/06/Ghostcat%20Tomcat%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E5%92%8C%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2020-1938%EF%BC%89/" title="Ghostcat Tomcat文件读取和文件包含漏洞（CVE-2020-1938）"><img class="cover" src="/img/bg9.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Ghostcat Tomcat文件读取和文件包含漏洞（CVE-2020-1938）</div></div></a></div><div class="next-post pull-right"><a href="/2024/03/02/java%E5%BA%8F%E5%88%97%E5%8C%96%E5%90%8E%E7%9A%84%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%A0%BC%E5%BC%8F%E5%88%86%E6%9E%90/" title="java序列化后的二进制格式分析"><img class="cover" src="/img/bg10.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">java序列化后的二进制格式分析</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/03/06/Ghostcat%20Tomcat%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E5%92%8C%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2020-1938%EF%BC%89/" title="Ghostcat Tomcat文件读取和文件包含漏洞（CVE-2020-1938）"><img class="cover" src="/img/bg9.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-03-06</div><div class="title">Ghostcat Tomcat文件读取和文件包含漏洞（CVE-2020-1938）</div></div></a></div><div><a href="/2023/09/18/java%E5%86%85%E5%AD%98%E9%A9%AC%E6%80%BB%E7%BB%93/" title="Java内存马总结"><img class="cover" src="/img/bg7.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-18</div><div class="title">Java内存马总结</div></div></a></div><div><a href="/2023/11/20/rasp%E7%BB%95%E8%BF%87/" title="Java中的RASP绕过"><img class="cover" src="/img/bg10.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-20</div><div class="title">Java中的RASP绕过</div></div></a></div><div><a href="/2023/02/26/%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F/" title="代理模式"><img class="cover" src="/img/bg3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-26</div><div class="title">代理模式</div></div></a></div><div><a href="/2024/03/02/java%E5%BA%8F%E5%88%97%E5%8C%96%E5%90%8E%E7%9A%84%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%A0%BC%E5%BC%8F%E5%88%86%E6%9E%90/" title="java序列化后的二进制格式分析"><img class="cover" src="/img/bg10.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-03-02</div><div class="title">java序列化后的二进制格式分析</div></div></a></div><div><a href="/2024/03/02/jdk7u21%E5%92%8Cjdk8u20%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" title="jdk7u21和jdk8u20原生反序列化漏洞分析"><img class="cover" src="/img/bg3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-03-02</div><div class="title">jdk7u21和jdk8u20原生反序列化漏洞分析</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/imgs/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">AnchorEureka</div><div class="author-info__description">just do it!</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">11</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">12</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">12</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/justdoit-cai"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/justdoit-cai" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:2068830937@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">大家一起冲冲冲!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">源码分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E6%B5%8B%E8%AF%95"><span class="toc-number">3.</span> <span class="toc-text">实验测试</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%9B%E4%B8%80%E6%AD%A5%E5%88%86%E6%9E%90"><span class="toc-number">4.</span> <span class="toc-text">进一步分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%A7%8Dreload%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="toc-number">4.1.</span> <span class="toc-text">第一种reload的方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E7%A7%8Dreload%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="toc-number">4.2.</span> <span class="toc-text">第二种reload的方式</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">5.</span> <span class="toc-text">总结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/03/06/Ghostcat%20Tomcat%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E5%92%8C%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2020-1938%EF%BC%89/" title="Ghostcat Tomcat文件读取和文件包含漏洞（CVE-2020-1938）"><img src="/img/bg9.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Ghostcat Tomcat文件读取和文件包含漏洞（CVE-2020-1938）"/></a><div class="content"><a class="title" href="/2024/03/06/Ghostcat%20Tomcat%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E5%92%8C%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2020-1938%EF%BC%89/" title="Ghostcat Tomcat文件读取和文件包含漏洞（CVE-2020-1938）">Ghostcat Tomcat文件读取和文件包含漏洞（CVE-2020-1938）</a><time datetime="2024-03-05T16:00:00.000Z" title="发表于 2024-03-06 00:00:00">2024-03-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/03/05/Tomcat%E7%9A%84SESSIONS.ser%E6%96%87%E4%BB%B6%E5%88%A9%E7%94%A8%E5%8F%8A%E5%85%B6%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" title="Tomcat的SESSIONS.ser文件利用及其源码分析"><img src="/img/haoyun.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Tomcat的SESSIONS.ser文件利用及其源码分析"/></a><div class="content"><a class="title" href="/2024/03/05/Tomcat%E7%9A%84SESSIONS.ser%E6%96%87%E4%BB%B6%E5%88%A9%E7%94%A8%E5%8F%8A%E5%85%B6%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" title="Tomcat的SESSIONS.ser文件利用及其源码分析">Tomcat的SESSIONS.ser文件利用及其源码分析</a><time datetime="2024-03-04T16:00:00.000Z" title="发表于 2024-03-05 00:00:00">2024-03-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/03/02/java%E5%BA%8F%E5%88%97%E5%8C%96%E5%90%8E%E7%9A%84%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%A0%BC%E5%BC%8F%E5%88%86%E6%9E%90/" title="java序列化后的二进制格式分析"><img src="/img/bg10.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="java序列化后的二进制格式分析"/></a><div class="content"><a class="title" href="/2024/03/02/java%E5%BA%8F%E5%88%97%E5%8C%96%E5%90%8E%E7%9A%84%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%A0%BC%E5%BC%8F%E5%88%86%E6%9E%90/" title="java序列化后的二进制格式分析">java序列化后的二进制格式分析</a><time datetime="2024-03-01T16:00:00.000Z" title="发表于 2024-03-02 00:00:00">2024-03-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/03/02/jdk7u21%E5%92%8Cjdk8u20%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" title="jdk7u21和jdk8u20原生反序列化漏洞分析"><img src="/img/bg3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="jdk7u21和jdk8u20原生反序列化漏洞分析"/></a><div class="content"><a class="title" href="/2024/03/02/jdk7u21%E5%92%8Cjdk8u20%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" title="jdk7u21和jdk8u20原生反序列化漏洞分析">jdk7u21和jdk8u20原生反序列化漏洞分析</a><time datetime="2024-03-01T16:00:00.000Z" title="发表于 2024-03-02 00:00:00">2024-03-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/11/20/rasp%E7%BB%95%E8%BF%87/" title="Java中的RASP绕过"><img src="/img/bg10.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Java中的RASP绕过"/></a><div class="content"><a class="title" href="/2023/11/20/rasp%E7%BB%95%E8%BF%87/" title="Java中的RASP绕过">Java中的RASP绕过</a><time datetime="2023-11-19T16:00:00.000Z" title="发表于 2023-11-20 00:00:00">2023-11-20</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/imgs/bg4.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2024 By AnchorEureka</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Just do it!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk(Object.assign({
      clientID: 'a7b0ec4b62c42ac613ca',
      clientSecret: '56756824e86a782ebc5759e0e1fe96021d171f66',
      repo: 'justdoit-cai.github.io',
      owner: 'justdoit-cai',
      admin: ['justdoit-cai'],
      id: 'ac6515b90cfe028cb35f4f10adf81f8b',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    getCSS('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css')
    getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.textContent= n
  }
}

if ('Gitalk' === 'Gitalk' || !true) {
  if (true) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="true" data-text="富强,民主,文明,和谐,自由,平等,公正,法治,爱国,敬业,诚信,友善" data-fontsize="22px" data-random="true" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>